name: CI/CD Pipeline Centralizado

on:
  push:
    branches: [main, develop]
    tags:
      - "v*.*.*" # Trigger en tags de semantic-release (v1.2.3)
  pull_request:
    branches: [main, develop]
  release:
    types: [created]

env:
  NODE_VERSION: "20.19.5"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/backstage

jobs:
  # Job 1: Validations
  validations:
    name: ðŸ” Code Quality
    uses: ./.github/workflows/validate-job.yml

  # Job 2: Semantic Release (solo en push a main/develop, no en tags)
  semantic-release:
    name: ðŸ“¦ Semantic Release
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && !startsWith(github.ref, 'refs/tags/')
    needs: validations
    uses: ./.github/workflows/release.yml
    secrets: inherit

  # Job 3: Container Build
  build:
    name: ðŸ—ï¸ Build
    if: |
      always() && 
      needs.validations.result == 'success' && 
      (needs.semantic-release.result == 'success' || needs.semantic-release.result == 'skipped') &&
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs: [validations, semantic-release]
    uses: ./.github/workflows/build-job.yml

  # Job 4: Security Scan (ahora recibe el digest del build)
  security-scan:
    name: ðŸ” Security Scan
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs: build
    uses: ./.github/workflows/security-job.yml
    with:
      image-digest: ${{ needs.build.outputs.image-digest }}

  # Job Final: Summary
  pipeline-summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-24.04
    needs: [validations, semantic-release, build, security-scan]
    if: always()

    steps:
      - name: Generate Dynamic Summary
        run: |
          echo "# ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determinar tipo de pipeline
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "**Pipeline Type**: ðŸ” PR Validation Only" >> $GITHUB_STEP_SUMMARY
            echo "**PR**: #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
            echo "**Target**: ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.ref }}" == refs/heads/main ]]; then
              echo "**Pipeline Type**: ðŸš€ Full Pipeline (Main Branch)" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ github.ref }}" == refs/heads/develop ]]; then
              echo "**Pipeline Type**: ðŸ—ï¸ Full Pipeline (Develop Branch)" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
              echo "**Pipeline Type**: ðŸ“¦ Versioned Release (Semantic Release)" >> $GITHUB_STEP_SUMMARY
              echo "**Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Validation | ${{ needs.validations.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Mostrar semantic-release solo si no es un tag
            if [[ "${{ github.ref }}" != refs/tags/* ]]; then
              echo "| ðŸ“¦ Semantic Release | ${{ needs.semantic-release.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "| ðŸ—ï¸ Build | ${{ needs.build.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ” Security Scan | ${{ needs.security-scan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

            # Mostrar digest si estÃ¡ disponible
            if [[ -n "${{ needs.build.outputs.image-digest }}" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## ðŸ³ Container Image" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Digest**: \`${{ needs.build.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Pull Command (by digest - immutable)" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build.outputs.image-digest }}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ðŸ—ï¸ Build | â­ï¸ Skipped (PR only)" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ” Security Scan | â­ï¸ Skipped (PR only)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## âœ¨ Pipeline Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Validation Stage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Artifact sharing (node_modules reused)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel execution (tests + linting)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency review (PRs only)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit tests with coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "### ðŸ—ï¸ Build Stage" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Multi-arch (AMD64 + ARM64)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Provenance attestation (SLSA)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… SBOM generation" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Smart tagging (metadata-action)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… BuildKit cache optimization" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Security Stage" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Scan by digest (immutable)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Vulnerability + config scan" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… SARIF upload to Security tab" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## ðŸ”„ Reused Workflows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Validation**: Reused from \`validate-job.yml\`" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "- âœ… **Build**: Reused from \`build-job.yml\`" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Security Scan**: Reused from \`security-job.yml\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ **Build**: Skipped (PR only)" >> $GITHUB_STEP_SUMMARY
            echo "- â­ï¸ **Security Scan**: Skipped (PR only)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
