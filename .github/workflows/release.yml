name: ðŸš€ Semantic Release Job

on:
  # Reusable workflow to be called from pipeline.yml
  workflow_call:
    outputs:
      new-release-published:
        description: "Whether a new release was published"
        value: ${{ jobs.release.outputs.new-release-published }}
      new-release-version:
        description: "Version of the new release"
        value: ${{ jobs.release.outputs.new-release-version }}
  # Manual trigger for dry-run and special cases
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no changes, only preview)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write # To create tags and commits
  issues: write # To comment on closed issues
  pull-requests: write # To comment on PRs

env:
  NODE_VERSION: "20.19.5"

jobs:
  release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-24.04
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new_release_published }}
      new-release-version: ${{ steps.semantic.outputs.new_release_version }}

    steps:
      - name: ðŸ“¥ Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for semantic-release
          persist-credentials: false

      - name: ðŸ”§ Setup Node.js with Yarn Cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: ðŸ“¦ Install Dependencies
        run: |
          yarn install --immutable

      - name: ðŸš€ Run Semantic Release Analysis
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ” Running in DRY RUN mode - No changes will be made"
            npx semantic-release --dry-run
          else
            echo "ðŸš€ Running LIVE release"
            # Capture semantic-release output to get version
            npx semantic-release 2>&1 | tee semantic-output.log
          fi
          
          # Capture semantic-release outputs - check .version file first (most reliable)
          if [[ -f .version ]]; then
            VERSION=$(cat .version)
            echo "new-release-published=true" >> $GITHUB_OUTPUT
            echo "new-release-version=${VERSION}" >> $GITHUB_OUTPUT
            echo "âœ… New release: ${VERSION}"
            echo "ðŸ“ Version file found: ${VERSION}"
          else
            # Fallback: parse from semantic-release output
            if grep -q "Published release" semantic-output.log 2>/dev/null; then
              VERSION=$(grep "Published release" semantic-output.log | grep -oP '\d+\.\d+\.\d+(-[a-zA-Z0-9.]+)?' | head -n1)
              if [[ -n "$VERSION" ]]; then
                echo "new-release-published=true" >> $GITHUB_OUTPUT
                echo "new-release-version=${VERSION}" >> $GITHUB_OUTPUT
                echo "âœ… New release: ${VERSION}"
                echo "ðŸ“ Version parsed from log: ${VERSION}"
              else
                echo "new-release-published=false" >> $GITHUB_OUTPUT
                echo "new-release-version=" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ No new release created"
              fi
            else
              echo "new-release-published=false" >> $GITHUB_OUTPUT
              echo "new-release-version=" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No new release created"
            fi
          fi

      - name: ðŸ“Š Generate Release Summary
        if: always()
        run: |
          echo "# ðŸš€ Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Debug: Show outputs
          echo "**ðŸ› Debug Info**:" >> $GITHUB_STEP_SUMMARY
          echo "- new-release-published: \`${{ steps.semantic.outputs.new_release_published }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- new-release-version: \`${{ steps.semantic.outputs.new_release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo "**Mode**: ðŸ” Dry Run (Preview only)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Mode**: ðŸš€ Manual Live Release" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Mode**: ðŸ¤– Automatic Release" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "**Release Type**: ðŸ·ï¸ Stable Release (v1.2.3)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.ref_name }}" == "develop" ]]; then
            echo "**Release Type**: ðŸ§ª Pre-release (v1.2.3-develop.1)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # If .version file exists, show the new version
          if [[ -f .version ]]; then
            NEW_VERSION=$(cat .version)
            echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**New Version**: \`${NEW_VERSION}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/${{ github.repository_owner }}/backstage:${NEW_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ghcr.io/${{ github.repository_owner }}/backstage:latest" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ No Release Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No new version was created. Possible reasons:" >> $GITHUB_STEP_SUMMARY
            echo "- No commits since last release" >> $GITHUB_STEP_SUMMARY
            echo "- Only chore/docs commits (no feat/fix)" >> $GITHUB_STEP_SUMMARY
            echo "- Dry run mode enabled" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
